---
title: "R Packages"
output: 
  learnr::tutorial:
    css: "css/style.css"
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r phs-logo, echo=FALSE, fig.align='right', out.width="40%"}
knitr::include_graphics("images/phs-logo.png")
```

## Introduction

Welcome to R Packages. This course is designed as a self-led introduction for anyone in Public Health Scotland. Throughout this course there will be quizzes to test your knowledge and opportunities to modify and write R code. This course focusses on building an understanding of packages from a development side, contributing to existing packages, and finally building your own packages.

<div class="info_box">
  <h4>Course Info</h4>
  <ul>
    <li><strong>Prerequisite:</strong> [Introduction to R](https://scotland.shinyapps.io/phs-learnr-intro/)</li>
    <li>This course is built to flow through sections and build on previous knowledge. If you're comfortable with a particular section, you can skip it.</li>
    <li>Most sections have multiple parts to them. Navigate the course by using the buttons at the bottom of the screen to Continue or go to the Next Topic.</li>
    <li>The course will also show progress through sections, a green tick will appear on sections you've completed, and it will remember your place if you decide to close your browser and come back later.</li>
  </ul>
</div>
</br>

### What is an R package?

An R package is essentially a collection of R functions They usually also include helpful information about each function, examples of how to use them and tests to make sure they work as they should. You'll probably be familiar with packages and use them already.


## Foundations
=======
An R package is essentially a collection of R functions. They usually also include helpful information about each function, examples of how to use them and tests to make sure they work as they should.

You are probably familiar with installing and using R packages, e.g.:

```{r familiar, eval = FALSE}
install.packages('dplyr')
library(dplyr)
```

...

If you don't know how to write functions with R, we suggest having a look at our course on that topic <LINK TO FUNCTIONS COURSE> before proceeding with this one.

### What's the point of packages?

The philosophy behind creating R packages is to collate functions written to make a specific task easier. If you do not have your commonly used functions in a package, then you may end up complicating your R scripts by having to define a lot of functions before you can get into what the script is actually supposed to do. For example:

```{r scriptStart, eval = FALSE}
# functions ---------------------------------------------------------------
mean_by_age <- function(data) {
  ...
  ...
  ...
  ...
}

summarise_column <- function(data, col_name) {
  ...
  ...
  ...
  ...
}

more functions...
...
...

# start of script ---------------------------------------------------------

The real script...

```

This not only makes scripts more complex and harder to read, but it can mean that you have function definitions across many different scripts. So if you want to make an improvement to one of your functions, you're going to need to find all the places you have defined it and change it in every instance. 

If your functions are not well managed, you can end up with differently defined functions with the same (or similar) names in different scripts. This can give you unexpected results if those functions do slightly different things.

R packages solve these problems by defining your functions in one place, and documenting them. This means that whenever you use a function, you know exactly what it's going to do. And it saves space in your scripts, making them more readable and easier to work on collaboratively.

### Structure of an R package

You can use "usethis" package to create an R package. 

```{r usethis_package, eval=FALSE}
install.packages("usethis")
```

Then you can create a new package:

```{r create_package, eval=FALSE}
library("usethis")

# Create a new package
create_package(filepath)
```

It will create a package structure for you automatically which contains a number of files and directories. The main ones are:

- a DESCRIPTION file
- a NAMESPACE file
- a directory called R/, which contains your R scripts such as functions
- a directory called man/, which contains your documentation for exposed functions
- an optional directory src/, which contains code written in C and FORTRAN
- an optional directory data/, which contains any dataset that you distribute with your package
- an optional directory demo/, which contains demos scripts
- an optional directory vignettes/, which contains vignette files (a vignette could be a more detailed documentation)

### Where are R packages? (GitHub and CRAN)

## Contributing to an R package

There are two main reasons you might want to contribute to an R package:
- To address a problem/issue within the package
- To expand what it can do (e.g., by adding a new function)

### Correcting/improving existing functions

### Adding new functions

You may have an idea for a function that would fit in well with a package.
Perhaps you have written a function that you often use in conjunction with that package.

For example, if you use `create_age_groups()` from our {phsmethods} package, you might find that you often want to summarise a dataset by age group after those groups have been created. So you could write a function that does this, and propose that it be added to {phsmethods} for others to use.

To add a function to a package, you will usually have to 'fork' or add a branch to the package's repository on GitHub. Then you can make changes to the package's code safely, without worrying about disrupting the package until you are finished making your changes.

Once you have done this you can create a new file in the folder named "R", where the R functions associated with a package are stored. The file should be named something like function-name.R, where you substitute "function-name" for the actual function name. Our new function for {phsmethods} will be called `mean_by_age()` so we will create a new file in the 'R' folder called 'mean_by_age.R'

Inside that file, we will write the code that defines our function. In this case, we will make a function that takes a dataframe, the name of the column containing age groups and the name of the column we want to summarise.

```{r}
mean_by_age <- function(data, age_col, summary_col) {
  data %>% group_by(across(age_col)) %>% 
    summarise(
      mean_age = mean(.data[[summary_col]])
    )
}
```


### Publishing your contributions

## Creating an R package

### Writing functions

### Writing documentation

#### The DESCRIPTION file

This file contains basic information about this package, such as:

- Package: mypkg - the name you give the package.
- Type: Package - other types could be data.
- Title: What the package does (short line) - a single line.
- Version: 1.0 - should relate to the current release.
- Date: 2022-09-01 - should relate to the current release.
- Author: Who wrote it - can be several names.
- Maintainer: Who to complain to <yourfault@somewhere.net> - one
name, plus a valid email address.
- Description: More about what it does (maybe more than one line) - a
single paragraph.
- License: What license is it under? - e.g. GPL (>=2).
• LazyLoad: yes/no - if yes, delays loading of functions until they are required. Usually yes.

Further important items:
- Depends, Imports, Suggests, Enhances and LinkingTo. These fields
contain comma-separated list of packages which are required in order to
fully run your package. May include details of the version required. For
example,

```{r depends_package, eval=FALSE}
Depends: R (>= 3.0.0)
```

#### NAMESPACE file

Typically in a package you don’t want users to access all of your functions. For example,

- They may access functions you don’t want them to.
- Namespace pollution - how many packages have a function called simulate()?
- You will have to write documentation for all exposed functions.
- It makes it harder to implement future changes.

The NAMESPACE file allows you expose a subset of your functions. For example, to export items a and b use export(a, b). 

This file is automatically generated by roxygen2 after running

```{r devtools_document, eval=FALSE}
install.packages("devtools")

devtools::document()
```

so it's not meant to be edited by hand. 

*Example NAMESPACE file*

```{r namespace_example, eval=FALSE}
export(age_calculate)
export(chi_check)
export(dob_from_chi)
export(extract_fin_year)
importFrom(magrittr,"%<>%")
importFrom(tibble,tibble)
```

#### The R/ directory

This directory contains all your R functions. All file extensions should be
.R Your functions typically don’t call `require()` or `library()` - instead
use `importFrom()`. You can create a function file by running

```{r create_function, eval=FALSE}
usethis::use_r(function_name)
```

It will automatically create a function file with the function name you set and get saved in R/ directory. 

You should create a .R file with the name of your package, which will store some information of the package such as a description of the package. You can also use roxygen2 `@importFrom` to import specific functions in certain packages. It will then be automatically added into NAMESPACE file. 

#### Help files: man/ directory

We can use "devtools" to do the package documentations. After running `devtools::document()` in Console it will transfer the roxygen2 to help files stored in man/ directory. 

The .R file with the name of your package will also be transferred to .Rd file with the package name saved in man/ directory. 

#### README and NEWS files

We always want to write some instructions about our package in README, so that users can see information about how to install the package and how to use the functions. You can use the following code to create a README.Rmd file:

```{r create_readme, eval=FALSE}
usethis::use_readme_rmd()
```

In YAML part of README.Rmd, you can set it as `output: github_document`. You can then click knit and it will automatically build README.md file, which will show on the main page of your package on Github if you upload it onto Github. 

Sometimes you may also like to keep a record about the changes of your package. You can create a NEWS.md file:

```{r create_news, eval=FALSE}
usethis::use_news_md()
```

Then you can write the changes of each version in NEWS.md. 

#### Package checks

Before distributing a package, we need to ensure that it passes some basic checks. You can run `devtools::check()` to run through the checks. If it shows any errors you shall fix them before releasing the package. 

### Writing tests

### Publishing the package

## Resources
